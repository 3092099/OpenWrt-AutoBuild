#!/usr/bin/env bash

name: Build OpenWrt

on:
  #schedule:
    #- cron: "0 0 1/2 * *"
  workflow_dispatch:

jobs:
  matrix:
    runs-on: ubuntu-24.04
    outputs:
      release: ${{ steps.set-matrix.outputs.release }}
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout
        uses: actions/checkout@main

      - name: Generate build matrix
        id: set-matrix
        run: |
          sudo timedatectl set-timezone "Asia/Shanghai"
          echo "release=$(date +"%Y.%m.%d-%H%M")" >> $GITHUB_OUTPUT

          # -m æ‰€æœ‰é¡¹ç›®ä»¥é€—å·åˆ†éš”ï¼Œå¹¶å¡«æ»¡æ•´è¡Œè¡Œå®½
          # -B ä¸åˆ—å‡ºä»»ä½•ä»¥ ~ å­—ç¬¦ç»“æŸçš„é¡¹ç›®
          # -Q å°†æ¡ç›®åç§°æ‹¬ä¸ŠåŒå¼•å·

          echo "matrix={ \"config\": [ $(echo $(ls -mBQ *.config)) ] }" >> $GITHUB_OUTPUT

  build:
    name: Build OpenWrt
    runs-on: ubuntu-latest
    needs: matrix
    env:
      release: ${{ needs.matrix.outputs.release }}
    strategy:
      matrix: ${{ fromJson(needs.matrix.outputs.matrix) }}

    steps:
      - name: Checkout
        uses: actions/checkout@main

      - name: Init Env
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          sudo timedatectl set-timezone "Asia/Shanghai"

          sudo apt update
          sudo apt full-upgrade -y
          sudo apt install -y ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
          bzip2 ccache cmake cpio curl device-tree-compiler fastjar flex gawk gettext gcc-multilib g++-multilib \
          git gperf haveged help2man intltool libc6-dev-i386 libelf-dev libfuse-dev libglib2.0-dev libgmp3-dev \
          libltdl-dev libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libpython3-dev libreadline-dev \
          libssl-dev libtool lrzsz mkisofs msmtp ninja-build p7zip p7zip-full patch pkgconf npm python3 \
          python3-pyelftools python3-setuptools qemu-utils rsync scons squashfs-tools subversion swig texinfo \
          uglifyjs upx-ucl unzip vim wget xmlto xxd zlib1g-dev
          
          # sudo apt install --reinstall libc6
          # sudo systemctl daemon-reload
          sudo apt -y autoremove --purge
          sudo apt -y clean

          git clone --depth=1 https://github.com/openwrt-dev/po2lmo
          (cd po2lmo && sudo make && sudo make install)

          df -h

      - name: Compile The Firmware
        run: |
          sudo mkdir -p /mnt/openwrt

          cd /mnt/openwrt
          
          sudo bash ${GITHUB_WORKSPACE}/build.sh "${GITHUB_WORKSPACE}/${{ matrix.config }}"

          if [ $(ls *.img* | wc -l) -le 0 ]; then
            echo "ç¼–è¯‘å¤±è´¥ï¼"
            exit 1
          fi

          #sudo zip -q -r $(basename "${{ matrix.config }}" .config | awk -F';' '{printf $1"-"$3}')-${{ env.release }}.zip *.img.gz
          echo "å½“å‰ç¼–è¯‘çš„æºä»£ç æ¥è‡ªï¼š${repo}ï¼Œå›ºä»¶å‹å·æ˜¯ï¼š${owner};"
          echo "repoçš„å€¼æ˜¯ï¼š${repo}"
          echo "======================="
          echo "ownerçš„å€¼æ˜¯ï¼š${owner}"
          echo "======================="
          echo "build_dateçš„å€¼æ˜¯ï¼š${build_date}"
          echo "======================="
          echo "è‡ªå®šä¹‰çš„å€¼æ˜¯ï¼š$(basename "${{ matrix.config }}" .config | awk -F';' '{printf $1"-"$3}')"
          echo "======================="

      - name: Upload firmware to release
        uses: softprops/action-gh-release@v2
        if: success() && !cancelled()
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
        with:
          tag_name: OpenWrt-AutoBuild
          files: /mnt/openwrt/*.img.gz

      - name: Telegram notification upload success
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_TO }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: |
            â™¨ï¸ ã€$(basename "${{ matrix.config }}" .config | awk -F';' '{printf $1"-"$3}')ã€‘é¡¹ç›®ç¼–è¯‘å®Œæˆ â™¨ï¸
            - âš½ å›ºä»¶åç§°ï¼š$(basename "${{ matrix.config }}" .config | awk -F';' '{printf $1"-"$3}')
            - ğŸ”´ å›ºä»¶å¤§å°ï¼šKernel=32Mï¼Œrootfs=968M
            - ğŸ’» å¹³å°æ¶æ„: x86-64
            - ğŸŒ» å›ºä»¶æºç : https://github.com/coolsnowwolf/lede
            - ğŸ’ æºç åˆ†æ”¯: master
            - ğŸš€ å†…æ ¸ç‰ˆæœ¬: 6.6
            - ğŸˆ Lcuiç‰ˆæœ¬ï¼š23.05
            - ğŸŒ é»˜è®¤åœ°å€ï¼š192.168.18.1
            - ğŸ”‘ é»˜è®¤å¯†ç ï¼šæ— å¯†ç 
            - ğŸ§Š æ›´æ–°æ—¶é—´ï¼š${{env.release}}
            https://github.com/3092099/OpenWrt-AutoBuild/releases/tag/OpenWrt-AutoBuild
    
      - name: Push notification upload success
        uses: xhnmt/pushplus-action@main
        with:
          token: ${{ secrets.PUSH_PLUS_TOKEN }}
          title: "${{ matrix.config }} é¡¹ç›®ç¼–è¯‘å®Œæˆ"
          content: |
             â™¨ï¸ ã€$(basename "${{ matrix.config }}" .config | awk -F';' '{printf $1"-"$3}')ã€‘é¡¹ç›®ç¼–è¯‘å®Œæˆ â™¨ï¸
             - âš½ å›ºä»¶åç§°ï¼š$(basename "${{ matrix.config }}" .config | awk -F';' '{printf $1"-"$3}')
             - ğŸ”´ å›ºä»¶å¤§å°ï¼šKernel=32Mï¼Œrootfs=968M
             - ğŸ’» å¹³å°æ¶æ„: x86-64
             - ğŸŒ» å›ºä»¶æºç : https://github.com/coolsnowwolf/lede
             - ğŸ’ æºç åˆ†æ”¯: master
             - ğŸš€ å†…æ ¸ç‰ˆæœ¬: 6.6
             - ğŸˆ Lcuiç‰ˆæœ¬ï¼š23.05
             - ğŸŒ é»˜è®¤åœ°å€ï¼š192.168.18.1
             - ğŸ”‘ é»˜è®¤å¯†ç ï¼šæ— å¯†ç 
             - ğŸ§Š æ›´æ–°æ—¶é—´ï¼š${{env.release}}
             https://github.com/3092099/OpenWrt-AutoBuild/releases/tag/OpenWrt-AutoBuild
